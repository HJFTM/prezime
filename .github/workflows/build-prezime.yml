name: Sync gh-pages from multiple repos

on:
  workflow_dispatch:
  schedule:
    - cron: "15 3 * * *"  # dnevno u 03:15 UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # omogućuje push u trenutni repo

    steps:
      # 1) Checkout default branch (s poviješću) da možemo kreirati gh-pages ako ne postoji
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Kreiraj gh-pages ako ne postoji (s minimalističkim index.html)
      - name: Ensure gh-pages branch exists
        shell: bash
        run: |
          if ! git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "gh-pages not found; creating…"
            git switch --orphan gh-pages
            git rm -r -f --ignore-unmatch * .[^.]* || true
            echo "<!doctype html><meta charset=utf-8><title>prezime</title>" > index.html
            git -c user.name="GitHub Action" -c user.email="action@github.com" add -A
            git -c user.name="GitHub Action" -c user.email="action@github.com" commit -m "Initialize gh-pages"
            git push origin gh-pages
          else
            echo "gh-pages exists."
          fi

      # 3) Sada radimo na gh-pages grani
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      # 4) Pripremi radni dir (NE briši .git). Očisti odredišne podmape za čist sync.
      - name: Prepare folders
        shell: bash
        run: |
          shopt -s dotglob
          mkdir -p Uvod Bosna Stupnik Dubrovnik tmp
          rm -rf Uvod/* Bosna/* Stupnik/* Dubrovnik/*

      # 5) Kloniraj izvorne gh-pages grane i rsync u podmape
      - name: Clone source gh-pages and sync
        shell: bash
        run: |
          # Ako su repoji privatni, koristi PAT varijantu (otkomentiraj linije ispod i dodaj secret SOURCE_PAT):
          # SRC="https://x-access-token:${{ secrets.SOURCE_PAT }}@github.com/HJFTM"
          # Ako su javni:
          SRC="https://github.com/HJFTM"

          declare -A MAP=( \
            ["uvod"]="uvod" \
            ["bosna"]="bosna" \
            ["stupnik"]="stupnik" \
            ["dubrovnik"]="dubrovnik" \
          )

          for repo in "${!MAP[@]}"; do
            dir="${MAP[$repo]}"
            echo ">>> Syncing $repo -> $dir/"
            git clone --depth=1 --branch gh-pages "$SRC/$repo.git" "tmp/$repo"
            rsync -av --delete "tmp/$repo/" "$dir/"
          done

          rm -rf tmp

      # 6) Commit & push promjene u gh-pages
      - name: Commit & push
        shell: bash
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes."
          else
            git commit -m "Sync gh-pages from uvod/bosna/stupnik/dubrovnik ($(date -u +%F_%T))"
            git push origin gh-pages
          fi
